# 3D 貨櫃裝載模擬系統

一個基於 Web 的互動式 3D 貨櫃裝載模擬與優化工具，使用智慧演算法計算最佳裝載配置，並提供即時 3D 視覺化呈現。

![Version](https://img.shields.io/badge/version-1.0.0-blue)
![License](https://img.shields.io/badge/license-MIT-green)
![Three.js](https://img.shields.io/badge/Three.js-r128-orange)

---

## 📋 目錄

- [功能特色](#功能特色)
- [系統需求](#系統需求)
- [快速開始](#快速開始)
- [使用說明](#使用說明)
- [技術架構](#技術架構)
- [核心演算法](#核心演算法)
- [函數參考](#函數參考)
- [資料結構](#資料結構)

---

## 功能特色

### 🎯 核心功能

| 功能 | 說明 |
|------|------|
| **貨櫃尺寸設定** | 自訂貨櫃長度、寬度、高度（單位：cm） |
| **貨物批量輸入** | 支援多行輸入，含名稱、尺寸、數量 |
| **智慧裝箱演算法** | 平面堆疊策略，最大化空間利用率 |
| **多層堆疊** | 支援跨越多物品的平面堆疊 |
| **3D 即時視覺化** | 互動式 3D 場景，支援旋轉、縮放、平移 |
| **裝載驗證** | 自動檢測重疊、超出邊界等問題 |

### 🎨 視覺化特性

- **顏色分層**：第1層（藍/綠）、第2層（橙/黃）、第3層+（紫/粉）、未裝載（紅）
- **名稱標籤**：每個貨物上方顯示名稱
- **層數標記**：第2層以上顯示 L2、L3... 標記
- **懸停提示**：顯示貨物詳細資訊
- **多視角切換**：等距、俯視、正視、側視

### ⚙️ 進階選項

- **可堆疊設定**：指定哪些貨物可被堆疊
- **可旋轉設定**：允許貨物水平旋轉90°
- **標籤顯示控制**：獨立開關名稱/層數標籤

---

## 系統需求

### 瀏覽器支援

| 瀏覽器 | 最低版本 |
|--------|----------|
| Chrome | 60+ |
| Firefox | 55+ |
| Safari | 12+ |
| Edge | 79+ |

### 硬體建議

- **處理器**：雙核心以上
- **記憶體**：4GB RAM
- **顯示卡**：支援 WebGL 2.0

---

## 快速開始

### 1. 開啟程式

直接在瀏覽器中開啟 `container-loading-3d.html` 檔案。

### 2. 設定貨櫃尺寸

在左側面板輸入貨櫃的長、寬、高（單位：cm）。

### 3. 輸入貨物清單

使用以下格式輸入貨物資訊：

```
名稱: 長 x 寬 x 高 x 數量
```

**範例：**
```
ME1-ME358: 49.8 x 35.8 x 36 x 358
MF154-MF635: 45.6 x 37.8 x 36.8 x 482
```

### 4. 計算裝載

點擊「解析貨物」→「計算裝載」，系統會自動計算最佳配置。

---

## 使用說明

### 輸入格式

```
名稱: 長度 x 寬度 x 高度 x 數量
```

| 欄位 | 說明 | 必填 |
|------|------|------|
| 名稱 | 貨物識別名稱 | ✅ |
| 長度 | 貨物長度（cm） | ✅ |
| 寬度 | 貨物寬度（cm） | ✅ |
| 高度 | 貨物高度（cm） | ✅ |
| 數量 | 貨物件數，預設為 1 | ❌ |

**支援的分隔符號：**
- 冒號：`:` 或 `：`（全形）
- 乘號：`x`、`X`、`×`

### 3D 場景操作

| 操作 | 動作 |
|------|------|
| 左鍵拖曳 | 旋轉視角 |
| 滾輪 | 縮放 |
| 右鍵拖曳 | 平移 |
| 視角按鈕 | 切換預設視角 |

### 儀表板指標

| 指標 | 說明 |
|------|------|
| 空間利用率 | 已裝載體積 / 貨櫃總體積 × 100% |
| 地面層 | 第1層貨物數量 |
| 堆疊 | 第2層以上貨物總數 |
| 裝載 | 已裝載數 / 總數 |
| 最高層數 | 當前配置的最大堆疊層數 |

---

## 技術架構

### 使用技術

```
┌─────────────────────────────────────────────┐
│                 前端架構                      │
├─────────────────────────────────────────────┤
│  HTML5          結構與語義化標記              │
│  CSS3           響應式佈局、漸層、動畫         │
│  JavaScript     ES5 相容性、事件處理          │
│  Three.js r128  3D 渲染引擎                  │
│  WebGL          硬體加速 3D 圖形              │
└─────────────────────────────────────────────┘
```

### 檔案結構

```
container-loading-3d.html    # 單一 HTML 檔案（內含所有 CSS 和 JS）
README.md                    # 說明文件
```

### 外部相依

| 套件 | 版本 | CDN |
|------|------|-----|
| Three.js | r128 | cdnjs.cloudflare.com |

---

## 核心演算法

### 平面堆疊策略（Platform Stacking Strategy）

本系統採用「平面堆疊」演算法，核心概念是：**同高度的貨物形成平面，其他貨物可跨越多個底層物品堆疊**。

#### 演算法流程

```
第一階段：地面放置
├── 1. 按面積排序（大的優先）
├── 2. 使用空間分割法放置
│   ├── 嘗試每個可用空間
│   ├── 嘗試不同方向（原始/旋轉90°）
│   └── 放置後分割剩餘空間
└── 3. 記錄所有已放置物品

第二階段：多層堆疊
├── 1. 找出所有唯一高度層級
├── 2. 對每個高度層級：
│   ├── 收集該高度的頂層可堆疊物品
│   ├── 嘗試放置未裝載物品：
│   │   ├── 方法A：放在單一物品上（優先）
│   │   └── 方法B：掃描找跨越多物品位置
│   └── 確保底部完全被支撐
└── 3. 重複直到無法放置更多
```

#### 支撐檢測邏輯

```javascript
// 檢查物品底部是否被完全支撐
function isFullySupported(x, z, l, w, baseHeight, baseItems) {
    // 1. 檢查四個角落
    // 2. 檢查網格點（間距 = 物品最小邊 / 3）
    // 3. 所有檢查點都必須有支撐物品在下方
}
```

#### 空間分割法

```
放置物品後的空間分割：
┌────────────────────┐
│     剩餘空間 B      │
│   (上方延伸)        │
├──────┬─────────────┤
│ 物品 │  剩餘空間 A   │
│      │  (右側延伸)   │
└──────┴─────────────┘
```

---

## 函數參考

### 初始化與渲染

| 函數 | 說明 |
|------|------|
| `init()` | 初始化 Three.js 場景、相機、燈光、事件監聽 |
| `animate()` | 動畫迴圈，持續渲染場景 |
| `createContainer()` | 創建貨櫃 3D 模型（地板、牆壁、邊框） |
| `createCargoMesh(item, colorIdx)` | 創建單個貨物的 3D 方塊 |

### 相機控制

| 函數 | 說明 |
|------|------|
| `updateCameraPosition()` | 根據球座標更新相機位置 |
| `resetCameraView()` | 重置相機到預設等距視角 |
| `setViewMode(mode, btnElement)` | 切換視角模式（iso/top/front/side） |
| `handleMouseDown(e)` | 滑鼠按下事件處理 |
| `handleMouseMove(e)` | 滑鼠移動事件處理（旋轉/平移/懸停） |
| `handleWheel(e)` | 滾輪事件處理（縮放） |

### 貨物管理

| 函數 | 說明 |
|------|------|
| `parseCargo()` | 解析輸入文字，產生貨物資料 |
| `renderCargoList()` | 渲染貨物設定清單 UI |
| `updateGroupOpt(groupId, prop)` | 更新群組選項（堆疊/旋轉） |
| `toggleAll(prop)` | 全選/取消全選 |
| `toggleLabels(type)` | 切換標籤顯示（name/layer） |

### 裝箱演算法

| 函數 | 說明 |
|------|------|
| `calculate()` | 主計算函數，觸發裝箱流程 |
| `packItemsPlatformStrategy(items, L, W, H)` | 平面堆疊演算法核心 |
| `boxesOverlap(a, b)` | 3D 方塊重疊檢測 |
| `rectsOverlap(...)` | 2D 矩形重疊檢測 |
| `checkPositionOverlap(newItem, placedItems)` | 檢查新位置是否與已放置物品重疊 |
| `isFullySupported(x, z, l, w, h, bases, step)` | 檢查是否被完全支撐 |
| `findSupportingItems(x, z, l, w, bases)` | 找出支撐物品清單 |

### 驗證與顯示

| 函數 | 說明 |
|------|------|
| `validateResult(placements)` | 驗證裝載結果（重疊、超界） |
| `showValidation(results)` | 顯示驗證結果 UI |
| `showAlert(stacked, unload, validation)` | 顯示警告橫幅 |
| `updateTooltip(e)` | 更新懸停提示內容 |

### 標籤創建

| 函數 | 說明 |
|------|------|
| `createNameLabel(text, isUnloaded)` | 創建名稱標籤 Sprite |
| `createLayerLabel(text)` | 創建層數標籤 Sprite |
| `addDimensionLabel(text, x, y, z)` | 添加尺寸標註 |

---

## 資料結構

### 貨物群組 (cargoGroups)

```javascript
{
    baseName: "ME1-ME358",    // 基礎名稱
    length: 49.8,             // 長度 (cm)
    width: 35.8,              // 寬度 (cm)
    height: 36,               // 高度 (cm)
    quantity: 358,            // 數量
    stackable: true,          // 可堆疊
    rotatable: true,          // 可旋轉
    groupId: 0                // 群組 ID
}
```

### 貨物資料 (cargoData)

```javascript
{
    id: 0,                    // 唯一識別碼
    name: "ME1-ME358-1",      // 完整名稱（含序號）
    baseName: "ME1-ME358",    // 基礎名稱
    length: 49.8,             // 原始長度
    width: 35.8,              // 原始寬度
    height: 36,               // 原始高度
    stackable: true,          // 可堆疊
    rotatable: true,          // 可旋轉
    groupId: 0                // 所屬群組
}
```

### 放置結果 (placements)

```javascript
{
    // 基本資訊
    id: 0,
    name: "ME1-ME358-1",
    baseName: "ME1-ME358",
    length: 49.8,
    width: 35.8,
    height: 36,
    
    // 放置資訊
    x: 0,                     // X 座標 (cm)
    y: 0,                     // Y 座標 (cm)，高度
    z: 0,                     // Z 座標 (cm)
    pL: 49.8,                 // 放置後長度
    pW: 35.8,                 // 放置後寬度
    pH: 36,                   // 放置後高度
    rotated: false,           // 是否旋轉
    layer: 1,                 // 層數
    stackedOn: null,          // 堆疊於哪個物品
    loaded: true              // 是否成功裝載
}
```

### 空間結構 (spaces)

```javascript
{
    x: 0,                     // 左下角 X
    z: 0,                     // 左下角 Z
    l: 1130,                  // 可用長度
    w: 230                    // 可用寬度
}
```

---

## 顏色配置

### 層級顏色

```javascript
// 第1層（地面）- 藍/綠色系
COLORS_L1 = [0x3b82f6, 0x22c55e, 0x06b6d4, 0x14b8a6, 0x84cc16, 0x0ea5e9]

// 第2層 - 橙/黃色系
COLORS_L2 = [0xf59e0b, 0xf97316, 0xeab308, 0xfbbf24]

// 第3層以上 - 紫/粉色系
COLORS_L3 = [0x8b5cf6, 0xa855f7, 0xd946ef, 0xec4899]

// 未裝載 - 紅色
COLOR_UNLOAD = 0xef4444
```

---

## 效能考量

### 大量貨物處理

| 貨物數量 | 預期效能 |
|----------|----------|
| < 500 | 流暢 |
| 500-1000 | 良好 |
| 1000-2000 | 可接受 |
| > 2000 | 可能有延遲 |

### 優化建議

1. **關閉標籤**：大量貨物時關閉名稱/層數標籤可提升效能
2. **減少迭代**：演算法最大迭代次數為 1000 次
3. **掃描步長**：預設 10cm，可調整以平衡精度與速度

---

## 限制與注意事項

1. **僅支援長方體**：目前不支援不規則形狀貨物
2. **無重量考量**：演算法不考慮貨物重量與重心
3. **單一貨櫃**：每次計算僅處理一個貨櫃
4. **支撐簡化**：假設同高度物品可形成完整平面

---

## 授權

MIT License

---

## 更新日誌

### v1.0.0 (2025)

- ✅ 基礎貨櫃與貨物設定
- ✅ 平面堆疊演算法
- ✅ 3D 視覺化與互動
- ✅ 標籤顯示控制
- ✅ 裝載驗證系統
